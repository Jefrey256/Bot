const fs  = require('fs');
const path = './armor/lib/rpg.json';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UTILITÃRIOS BÃSICOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const salvar   = (db) => fs.writeFileSync(path, JSON.stringify(db, null, 2));
const carregar = () => fs.existsSync(path) ? JSON.parse(fs.readFileSync(path)) : {};

const loja = {                 // itens disponÃ­veis para compra
  comida:      { nome: 'Comida Premium',   preco: 50,  efeito: { fome: +50 } },
  shampoo:     { nome: 'Shampoo',          preco: 70,  efeito: { higiene: +70 } },
  energetico:  { nome: 'EnergÃ©tico',       preco: 100, efeito: { sono: +80, vida: -10 } },
  cura:        { nome: 'PoÃ§Ã£o de Cura',    preco: 200, efeito: { vida: +100 } },
  roupaazul:   { nome: 'Roupa Azul',       preco: 150, tipo: 'roupa' },
  skindragao:  { nome: 'Skin DragÃ£o',      preco: 300, tipo: 'skin' }
};

const aplicarEfeito = (user, efeito = {}) => {
  for (const [k, v] of Object.entries(efeito)) {
    user[k] = Math.max(0, Math.min(100, user[k] + v));
  }
};

const ganharXp = (user, qtd = 10) => {
  user.xp += qtd;
  const preciso = 100 + (user.nivel - 1) * 50;
  if (user.xp >= preciso) {
    user.xp -= preciso;
    user.nivel += 1;
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FUNÃ‡Ã•ES DE CASES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// REGISTRAR
function caseregistrar(kimorin, from, id, prefix, pushname) {
  try {
    const db = carregar();

    if (db[id]) {
      return kimorin.sendMessage(from, { text: 'ğŸªª VocÃª jÃ¡ estÃ¡ registrado!' });
    }

    db[id] = {
      nome: pushname || "Jogador",
      moedas: 500,
      xp: 0,
      nivel: 1,
      vida: 100,
      fome: 100,
      energia: 100,
      banco: 0,
      trabalho: null,
      trabalhos: 0,
      conquistou: [],
      desafios: [],
      pet: null,
      casa: null,
      familia: [],
      inventario: [],
      ultimos: {},
      sorte: {},
      ultSorte: "",
      promovido: false
    };

salvar(db);
    kimorin.sendMessage(from, {
      text: `âœ… *Registro completo!*\n\nBem-vindo ao RPG, *${pushname || "Jogador"}*!\nUse *menu* ou *ajuda* para ver os comandos.`
    });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro ao registrar: ${e.message}` });
  }
}

// STATUS
function casestatus(kimorin, from, id, prefix) {
  try {
    const user = carregar()[id];
    if (!user) return kimorin.sendMessage(from, {text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    kimorin.sendMessage(from, {
      text: `ğŸ“Š *STATUS DE ${user.nome}*\n`
          + `â¤ï¸ Vida: ${user.vida}/100 (${user.status})\n`
          + `ğŸ´ Fome: ${user.fome}/100\nğŸ’¤ Sono: ${user.sono}/100\nğŸ› Higiene: ${user.higiene}/100`
          + `\nğŸ‰ DiversÃ£o: ${user.diversao}/100\nğŸ’° Moedas: ${user.moedas}\nâ­ NÃ­vel: ${user.nivel} | XP: ${user.xp}\n`
    });
  } catch(e){ kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`}); }
}

// ALIMENTAR
function casealimentar(kimorin, from, id, prefix) {
  try {
    const db   = carregar(); const u = db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    if(u.moedas<20) return kimorin.sendMessage(from,{text:'ğŸ’¸ Sem moedas suficientes.'});
    if(u.fome>=100) return kimorin.sendMessage(from,{text:'ğŸ½ï¸ JÃ¡ estÃ¡ satisfeito!'});
    u.moedas -= 20; aplicarEfeito(u,{fome:+30}); ganharXp(u,5);
    salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ• Alimentado! Fome ${u.fome}/100\nğŸ’° Moedas: ${u.moedas}`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// DORMIR
function casedormir(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    aplicarEfeito(u,{sono:+50}); ganharXp(u,5); salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ˜´ Dormiu bem! Sono ${u.sono}/100`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// BANHO
function casebanho(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    aplicarEfeito(u,{higiene:+40}); ganharXp(u,5); salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ§¼ Banho tomado! Higiene ${u.higiene}/100`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// BRINCAR
function casebrincar(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    aplicarEfeito(u,{diversao:+40,sono:-10,fome:-10}); ganharXp(u,8); u.missoes.brincar=true;
    salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ® Brincou! DiversÃ£o ${u.diversao}/100 (Sono -10 / Fome -10)`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// TRABALHAR
function casetrabalhar(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    const ganho=Math.floor(Math.random()*101)+50;
    u.moedas+=ganho; aplicarEfeito(u,{sono:-20,fome:-20,diversao:-10}); ganharXp(u,10);
    salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ’¼ Trabalhou e ganhou ğŸ’°${ganho}\n(Sono -20 / Fome -20 / DiversÃ£o -10)`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ECONOMIA & ITENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// LOJA
function caseloja(kimorin,from, prefix){
  try{
    let msg='ğŸª *LOJA DE ITENS*\n\n';
    Object.entries(loja).forEach(([k,v])=>{
      msg+=`ğŸ”¹ ${v.nome} â€” ${v.preco} moedas ${v.efeito?`| Efeito: ${JSON.stringify(v.efeito)}`:''}\n`;
    });
    msg+='\nUse: comprar [item]';
    kimorin.sendMessage(from,{text:msg});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// COMPRAR
function casecomprar(kimorin,from,id,args, prefix){
  try{
    const item=args[0]?.toLowerCase();
    if(!item||!loja[item]) return kimorin.sendMessage(from,{text:'âŒ Item inexistente.'});
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    const prod=loja[item];
    if(u.moedas<prod.preco) return kimorin.sendMessage(from,{text:'ğŸ’¸ Moedas insuficientes.'});
    u.moedas-=prod.preco; u.inventario.push(item); salvar(db);
    kimorin.sendMessage(from,{text:`âœ… VocÃª comprou ${prod.nome}!\nğŸ’° Moedas restantes: ${u.moedas}`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// INVENTÃRIO
function caseinventario(kimorin,from,id, prefix){
  try{
    const u=carregar()[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    if(!u.inventario.length) return kimorin.sendMessage(from,{text:'ğŸ“¦ InventÃ¡rio vazio.'});
    const lista=u.inventario.map((it,i)=>`${i+1}. ${loja[it]?.nome || it}`).join('\n');
    kimorin.sendMessage(from,{text:`ğŸ“¦ *InventÃ¡rio*\n${lista}\n\nUse: usaritem [item] | equipar [item]`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// USAR ITEM
function caseusaritem(kimorin,from,id,args, prefix){
  try{
    const item=args[0]?.toLowerCase();
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    const idx=u.inventario.indexOf(item);
    if(idx===-1) return kimorin.sendMessage(from,{text:'âŒ Item nÃ£o estÃ¡ no inventÃ¡rio.'});
    const prod=loja[item];
    if(prod.tipo){ // roupas/skins nÃ£o sÃ£o â€œusadasâ€, mas equipadas
      return kimorin.sendMessage(from,{text:'âš ï¸ Esse item Ã© para *equipar*, use: equipar [item]'});
    }
    aplicarEfeito(u,prod.efeito); u.inventario.splice(idx,1); ganharXp(u,5);
    salvar(db);
    kimorin.sendMessage(from,{text:`âœ… Usou ${prod.nome}!\nStatus atualizados.`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// EQUIPAR ROUPA / SKIN
function caseequipar(kimorin,from,id,args, prefix){
  try{
    const item=args[0]?.toLowerCase();
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    if(!u.inventario.includes(item)) return kimorin.sendMessage(from,{text:'âŒ Item nÃ£o estÃ¡ no inventÃ¡rio.'});
    const prod=loja[item];
    if(!prod.tipo) return kimorin.sendMessage(from,{text:'âŒ Esse item nÃ£o Ã© equipÃ¡vel.'});
    u.equipado[prod.tipo]=item;
    salvar(db);
    kimorin.sendMessage(from,{text:`ğŸ‘— VocÃª equipou ${prod.nome}!`});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// CURA DO PET
function casecura(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    if(u.status!=='doente') return kimorin.sendMessage(from,{text:'ğŸ˜ Seu pet nÃ£o estÃ¡ doente.'});
    if(u.moedas<200) return kimorin.sendMessage(from,{text:'ğŸ’¸ 200 moedas necessÃ¡rias para tratamento.'});
    u.moedas-=200; u.status='vivo'; u.vida=100; salvar(db);
    kimorin.sendMessage(from,{text:'â¤ï¸ Seu pet foi curado!'});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MISSÃ•ES DIÃRIAS & RANKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// MISSÃ•ES
function casemissoes(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    const todasFeitas = Object.values(u.missoes).every(v=>v);
    if(todasFeitas){
      u.missoes={brincar:false,alimentar:false,banho:false};
      u.moedas+=100; ganharXp(u,20); salvar(db);
      return kimorin.sendMessage(from,{text:'ğŸ‰ MissÃµes completas! +100 moedas e +20 XP. Reiniciando missÃµes.'});
    }
    let txt='ğŸ“œ *MissÃµes diÃ¡rias*\n';
    Object.entries(u.missoes).forEach(([k,v])=>{
      txt+=`â€¢ ${k.charAt(0).toUpperCase()+k.slice(1)}: ${v?'âœ…':'âŒ'}\n`;
    });
    txt+='\nConclua todas para ganhar +100 moedas e 20 XP.';
    kimorin.sendMessage(from,{text:txt});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

// RANKING
function caseranking(kimorin,from,prefix,tipo='nivel'){
  try{
    const db=carregar(); const arr=Object.entries(db);
    if(!arr.length) return kimorin.sendMessage(from,{text:'âš ï¸ Sem jogadores registrados.'});
    let lista=arr.sort((a,b)=>b[1][tipo]-a[1][tipo]).slice(0,10);
    let txt=`ğŸ† *Top 10 por ${tipo === 'nivel' ? 'NÃ­vel' : 'Moedas'}*\n`;
    lista.forEach(([id,u],i)=>{
      txt+=`${i+1}. ${u.nome} â€” ${u[tipo]}\n`;
    });
    kimorin.sendMessage(from,{text:txt});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

function caserankingxp(kimorin, from, prefix) {
  try {
    const db = carregar();
    const usuarios = Object.values(db);

    usuarios.sort((a, b) => (b.nivel || 0) - (a.nivel || 0));
    let texto = "ğŸ† *Ranking de NÃ­veis* ğŸ†\n\n";
    usuarios.slice(0, 10).forEach((u, i) => {
      texto += `${i + 1}. ${u.nome} - NÃ­vel: ${u.nivel || 0} | XP: ${u.xp || 0}\n`;
    });

    kimorin.sendMessage(from, { text: texto });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

const eventosAleatorios = [
  { texto: "VocÃª encontrou uma fonte mÃ¡gica e recuperou 50 de vida!", acao: (u) => { u.vida = Math.min(100, (u.vida || 100) + 50); } },
  { texto: "Um ladrÃ£o roubou 100 moedas suas!", acao: (u) => { u.moedas = Math.max(0, (u.moedas || 0) - 100); } },
  { texto: "VocÃª achou um baÃº com 200 moedas!", acao: (u) => { u.moedas = (u.moedas || 0) + 200; } },
  { texto: "Um raio caiu perto de vocÃª, perdeu 30 de vida!", acao: (u) => { u.vida = Math.max(0, (u.vida || 100) - 30); } },
];

function caseevento(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const evento = eventosAleatorios[Math.floor(Math.random() * eventosAleatorios.length)];
    evento.acao(u);
    salvar(db);

    kimorin.sendMessage(from, { text: `ğŸ² Evento: ${evento.texto}` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

const desafios = [
  { id: 'duelo', descricao: 'VenÃ§a 3 duelos', objetivo: 3 },
  { id: 'explorar', descricao: 'Explore 5 vezes', objetivo: 5 }
];

function casedesafios(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    if (!u.desafios) {
      u.desafios = desafios.map(d => ({ id: d.id, progresso: 0, completo: false }));
    }

    let texto = "*ğŸ¯ Desafios Atuais:*\n";
    u.desafios.forEach(d => {
      const def = desafios.find(x => x.id === d.id);
      texto += `- ${def.descricao}: ${d.progresso}/${def.objetivo} ${d.completo ? 'âœ…' : 'âŒ'}\n`;
    });

    salvar(db);
    kimorin.sendMessage(from, { text: texto });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function atualizarDesafio(u, idDesafio, qtd=1) {
  if (!u.desafios) return;
  const d = u.desafios.find(x => x.id === idDesafio);
  if (!d || d.completo) return;
  d.progresso += qtd;
  const obj = desafios.find(x => x.id === idDesafio).objetivo;
  if (d.progresso >= obj) d.completo = true;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EXPLORAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function caseexplorar(kimorin, from, id) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const eventos = [
      { tipo: 'moedas', qtd: Math.floor(Math.random() * 100) + 50 },
      { tipo: 'item', nome: Object.keys(loja)[Math.floor(Math.random() * Object.keys(loja).length)] },
      { tipo: 'nada' },
      { tipo: 'inimigo', dano: Math.floor(Math.random() * 40) + 10 }
    ];

    const resultado = eventos[Math.floor(Math.random() * eventos.length)];
    let texto = '';

    switch (resultado.tipo) {
      case 'moedas':
        u.moedas += resultado.qtd;
        texto = `ğŸŒ VocÃª encontrou ğŸ’° ${resultado.qtd} moedas durante a exploraÃ§Ã£o!`;
        break;
      case 'item':
        u.inventario.push(resultado.nome);
        texto = `ğŸŒ¿ VocÃª encontrou um item: ğŸ *${loja[resultado.nome].nome}*!`;
        break;
      case 'nada':
        texto = 'ğŸ˜• VocÃª explorou mas nÃ£o encontrou nada.';
        break;
      case 'inimigo':
        u.vida -= resultado.dano;
        if (u.vida <= 0) {
          u.vida = 0;
          u.status = 'morto';
          texto = `â˜ ï¸ Um monstro te atacou e vocÃª morreu!`;
        } else {
          texto = `âš”ï¸ Um inimigo te atacou e vocÃª perdeu ${resultado.dano} de vida. â¤ï¸ Vida atual: ${u.vida}/100`;
        }
        break;
    }

    ganharXp(u, 10);
    salvar(db);
    kimorin.sendMessage(from, { text: texto });

  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ROUBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function caseroubar(kimorin, from, id, args, prefix) {
  try {
    const alvo = (args[0] || '').replace(/[@+]/g, '') + '@s.whatsapp.net';
    const db = carregar();
    const u = db[id];
    const v = db[alvo];

    if (!u || !v) return kimorin.sendMessage(from, { text: 'âŒ Ambos jogadores devem estar registrados.' });
    if (id === alvo) return kimorin.sendMessage(from, { text: 'ğŸ™„ NÃ£o pode roubar a si mesmo.' });
    if (u.status !== 'vivo' || v.status !== 'vivo') return kimorin.sendMessage(from, { text: 'âŒ Um dos jogadores estÃ¡ morto ou invÃ¡lido.' });

    const chance = Math.random();
    if (chance < 0.5) {
      // Falha
      const multa = 50;
      u.moedas = Math.max(0, u.moedas - multa);
      salvar(db);
      return kimorin.sendMessage(from, { text: `ğŸš« VocÃª tentou roubar ${v.nome} mas foi pego!\nğŸ’¸ Perdeu ${multa} moedas.` });
    } else {
      // Sucesso
      const valor = Math.floor(v.moedas * 0.25);
      v.moedas -= valor;
      u.moedas += valor;
      salvar(db);
      return kimorin.sendMessage(from, { text: `ğŸ’° Roubo bem-sucedido!\nVocÃª roubou ${valor} moedas de ${v.nome}.` });
    }

  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CURAR OUTRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function casecurar(kimorin, from, id, args, prefix) {
  try {
    const alvo = (args[0] || '').replace(/[@+]/g, '') + '@s.whatsapp.net';
    const db = carregar();
    const u = db[id];
    const v = db[alvo];

    if (!u || !v) return kimorin.sendMessage(from, { text: 'âŒ Ambos devem estar registrados.' });
    if (!u.inventario.includes('cura')) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o tem poÃ§Ã£o de cura.' });

    v.vida = 100;
    v.status = 'vivo';
    u.inventario.splice(u.inventario.indexOf('cura'), 1);
    salvar(db);

    kimorin.sendMessage(from, { text: `â¤ï¸ VocÃª curou ${v.nome} usando uma PoÃ§Ã£o de Cura.` });

  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COLETA DIÃRIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function casecoletar(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const hoje = new Date().toDateString();
    const ultima = new Date(u.ultimaColeta || '').toDateString();

    if (hoje === ultima) {
      return kimorin.sendMessage(from, { text: 'ğŸ• VocÃª jÃ¡ coletou sua recompensa diÃ¡ria hoje!' });
    }

    const recompensa = 200;
    u.moedas += recompensa;
    u.ultimaColeta = new Date().toISOString();
    salvar(db);

    kimorin.sendMessage(from, { text: `ğŸ Recompensa diÃ¡ria coletada: ğŸ’° ${recompensa} moedas!` });

  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOAR MOEDAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function casedoar(kimorin, from, id, args, prefix) {
  try {
    const alvo = (args[0] || '').replace(/[@+]/g, '') + '@s.whatsapp.net';
    const valor = parseInt(args[1]);
    const db = carregar();
    const u = db[id];
    const v = db[alvo];

    if (!u || !v) return kimorin.sendMessage(from, { text: 'âŒ Ambos devem estar registrados.' });
    if (isNaN(valor) || valor <= 0) return kimorin.sendMessage(from, { text: 'âŒ Valor invÃ¡lido.' });
    if (u.moedas < valor) return kimorin.sendMessage(from, { text: 'ğŸ’¸ VocÃª nÃ£o tem moedas suficientes.' });

    u.moedas -= valor;
    v.moedas += valor;
    salvar(db);

    kimorin.sendMessage(from, { text: `ğŸ¤ VocÃª doou ğŸ’° ${valor} moedas para ${v.nome}.` });

  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}
// Criar Pet
function casecriarpet(kimorin, from, id, args, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (u.pet) return kimorin.sendMessage(from, { text: 'ğŸ¾ VocÃª jÃ¡ tem um pet!' });

    const nomePet = args.join(' ') || 'Petzinho';
    u.pet = {
      nome: nomePet,
      fome: 100,
      energia: 100,
      higiene: 100,
      felicidade: 100,
      nivel: 1,
      xp: 0
    };
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ¾ Pet ${nomePet} criado com sucesso! Cuide bem dele.` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Mostrar status do pet
function casestatuspet(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.pet) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o tem pet.' });

    const p = u.pet;
    const status = `ğŸ¾ *Status do Pet ${p.nome}*\n`
      + `ğŸ´ Fome: ${p.fome}/100\nâš¡ Energia: ${p.energia}/100\nğŸ› Higiene: ${p.higiene}/100\n`
      + `ğŸ‰ Felicidade: ${p.felicidade}/100\nâ­ NÃ­vel: ${p.nivel} | XP: ${p.xp}`;
    kimorin.sendMessage(from, { text: status });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Alimentar pet
function casealimentarpet(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.pet) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o tem pet.' });

    if (u.moedas < 30) return kimorin.sendMessage(from, { text: 'ğŸ’¸ VocÃª nÃ£o tem moedas suficientes para alimentar o pet.' });
    u.moedas -= 30;

    u.pet.fome = Math.min(100, u.pet.fome + 40);
    u.pet.felicidade = Math.min(100, u.pet.felicidade + 15);
    u.pet.xp += 10;

    if (u.pet.xp >= 100) {
      u.pet.xp -= 100;
      u.pet.nivel++;
      kimorin.sendMessage(from, { text: `ğŸ‰ Seu pet ${u.pet.nome} subiu para o nÃ­vel ${u.pet.nivel}!` });
    }

    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ– VocÃª alimentou seu pet ${u.pet.nome}!\nFome: ${u.pet.fome}/100\nFelicidade: ${u.pet.felicidade}/100` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Treinar pet (aumenta xp, consome energia)
function casetreinarpet(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.pet) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o tem pet.' });

    if (u.pet.energia < 30) return kimorin.sendMessage(from, { text: 'ğŸ˜´ Seu pet estÃ¡ cansado demais para treinar.' });

    u.pet.energia -= 30;
    u.pet.xp += 25;
    u.pet.felicidade = Math.min(100, u.pet.felicidade + 10);

    if (u.pet.xp >= 100) {
      u.pet.xp -= 100;
      u.pet.nivel++;
      kimorin.sendMessage(from, { text: `ğŸ‰ Seu pet ${u.pet.nome} subiu para o nÃ­vel ${u.pet.nivel}!` });
    }
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ‹ï¸â€â™‚ï¸ VocÃª treinou seu pet ${u.pet.nome}!\nEnergia: ${u.pet.energia}/100\nXP: ${u.pet.xp}` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Pedir casamento
function casecasar(kimorin, from, id, args, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (u.casadoCom) return kimorin.sendMessage(from, { text: 'â¤ï¸ VocÃª jÃ¡ Ã© casado(a).' });

    const alvoId = (args[0] || '').replace(/[@+]/g, '') + '@s.whatsapp.net';
    if (!db[alvoId]) return kimorin.sendMessage(from, { text: 'âŒ A pessoa nÃ£o estÃ¡ registrada.' });
    if (id === alvoId) return kimorin.sendMessage(from, { text: 'ğŸ™„ NÃ£o pode casar consigo mesmo.' });
    if (db[alvoId].casadoCom) return kimorin.sendMessage(from, { text: 'âŒ A pessoa jÃ¡ Ã© casada.' });

    u.pedidoCasamento = alvoId;
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ’ Pedido de casamento enviado para ${db[alvoId].nome}.` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Aceitar casamento
function caseaceitarcasamento(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (u.casadoCom) return kimorin.sendMessage(from, { text: 'â¤ï¸ VocÃª jÃ¡ Ã© casado(a).' });

    const pedido = Object.entries(db).find(([uid, usr]) => usr.pedidoCasamento === id);
    if (!pedido) return kimorin.sendMessage(from, { text: 'âŒ NinguÃ©m te pediu em casamento.' });

    const [pid, parceiro] = pedido;

    u.casadoCom = pid;
    parceiro.casadoCom = id;

    parceiro.pedidoCasamento = null;
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ’– ParabÃ©ns! VocÃª e ${u.nome} agora sÃ£o casados(as)!` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// DivÃ³rcio
function casedivorcio(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (!u.casadoCom) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o estÃ¡ casado.' });

    const parceiroId = u.casadoCom;
    u.casadoCom = null;
    if (db[parceiroId]) db[parceiroId].casadoCom = null;

    salvar(db);
    kimorin.sendMessage(from, { text: 'ğŸ’” DivÃ³rcio efetuado com sucesso.' });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

const trabalhos = {
  pedreiro: { ganhoMin: 50, ganhoMax: 120, descricao: 'ConstrÃ³i casas.' },
  agricultor: { ganhoMin: 40, ganhoMax: 100, descricao: 'Cuida das plantaÃ§Ãµes.' },
  professor: { ganhoMin: 60, ganhoMax: 130, descricao: 'Ensina nas escolas.' },
  programador: { ganhoMin: 100, ganhoMax: 250, descricao: 'Desenvolve sistemas.' },

  // Raros
  astronauta: { ganhoMin: 400, ganhoMax: 700, descricao: 'Explora o espaÃ§o.', raridade: true, requisitoNivel: 10 },
  hacker: { ganhoMin: 300, ganhoMax: 600, descricao: 'Invade sistemas.', raridade: true, requisitoNivel: 8 }
};

// Escolher trabalho
function caseescolhertrabalho(kimorin, from, id, args, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const job = args[0]?.toLowerCase();
    if (!job || !trabalhos[job]) {
      const lista = Object.entries(trabalhos).map(([k, v]) => `- ${k} (${v.raridade ? 'ğŸ”’ Raro' : 'Comum'})`).join('\n');
      return kimorin.sendMessage(from, { text: `ğŸ’¼ Trabalhos disponÃ­veis:\n${lista}` });
    }

    const trabalho = trabalhos[job];
    if (trabalho.raridade && (u.nivel || 0) < trabalho.requisitoNivel) {
      return kimorin.sendMessage(from, { text: `ğŸ”’ Esse trabalho exige nÃ­vel ${trabalho.requisitoNivel}.` });
    }

    u.trabalho = job;
    salvar(db);
    kimorin.sendMessage(from, { text: `âœ… Agora vocÃª trabalha como *${job}*. ${trabalho.descricao}` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Trabalhar
function casetrabalhar(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.trabalho || !trabalhos[u.trabalho]) {
      return kimorin.sendMessage(from, {
        text: `âŒ VocÃª precisa escolher um trabalho. Use: *escolhertrabalho [nome]*`
      });
    }

    const job = trabalhos[u.trabalho];
    const ganho = Math.floor(Math.random() * (job.ganhoMax - job.ganhoMin + 1)) + job.ganhoMin;

    u.moedas = (u.moedas || 0) + ganho;
    u.xp = (u.xp || 0) + 10;
    u.trabalhos = (u.trabalhos || 0) + 1;

    // chance de promoÃ§Ã£o
    if ((u.trabalhos % 10 === 0) && !u.promovido) {
      u.moedas += 100;
      u.promovido = true;
      kimorin.sendMessage(from, { text: 'ğŸ‰ VocÃª foi promovido e recebeu um bÃ´nus de 100 moedas!' });
    } else if (u.trabalhos % 10 !== 0) {
      u.promovido = false;
    }

    salvar(db);
    kimorin.sendMessage(from, {
      text: `ğŸ’¼ VocÃª trabalhou como *${u.trabalho}*.\nğŸ’° Ganhou *${ganho} moedas*\nğŸ“ˆ XP: +10`
    });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function casevertrabalho(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.trabalho) return kimorin.sendMessage(from, { text: 'âŒ VocÃª ainda nÃ£o escolheu um trabalho.' });

    const info = trabalhos[u.trabalho];
    kimorin.sendMessage(from, {
      text: `ğŸ’¼ *Seu Trabalho:*\nğŸ“› ${u.trabalho}\nğŸ“‹ ${info.descricao}\nğŸ’¸ SalÃ¡rio: ${info.ganhoMin} - ${info.ganhoMax}\nğŸ§ª Total de Trabalhos: ${u.trabalhos || 0}`
    });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function casedemitir(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.trabalho) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o estÃ¡ em nenhum trabalho.' });

    const nome = u.trabalho;
    delete u.trabalho;
    salvar(db);

    kimorin.sendMessage(from, { text: `ğŸ“‰ VocÃª foi demitido do cargo de *${nome}*.` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function caseferias(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.trabalho) return kimorin.sendMessage(from, { text: 'âŒ VocÃª nÃ£o trabalha atualmente.' });

    u.vida = Math.min(100, (u.vida || 100) + 20);
    kimorin.sendMessage(from, {
      text: `ğŸ–ï¸ VocÃª tirou fÃ©rias e descansou.\nâ¤ï¸ Vida restaurada em 20 pontos!`
    });
    salvar(db);
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

const casas = {
  cabana: { preco: 1000, descricao: 'Uma cabana simples.' },
  apartamento: { preco: 5000, descricao: 'Apartamento confortÃ¡vel.' },
  mansao: { preco: 20000, descricao: 'MansÃ£o luxuosa.' }
};

// Comprar casa
function casecomprarcasa(kimorin, from, id, args, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (u.casa) return kimorin.sendMessage(from, { text: `ğŸ  VocÃª jÃ¡ tem uma casa: ${u.casa}` });

    const casa = args[0]?.toLowerCase();
    if (!casa || !casas[casa]) return kimorin.sendMessage(from, { text: 'âŒ Casa invÃ¡lida. OpÃ§Ãµes: ' + Object.keys(casas).join(', ') });

    if (u.moedas < casas[casa].preco) return kimorin.sendMessage(from, { text: 'ğŸ’¸ Moedas insuficientes.' });

    u.moedas -= casas[casa].preco;
    u.casa = casa;
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ  ParabÃ©ns! VocÃª comprou uma casa: ${casa}.\nDescriÃ§Ã£o: ${casas[casa].descricao}` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Ver casa
function caseminhacasa(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u || !u.casa) return kimorin.sendMessage(from, { text: 'ğŸšï¸ VocÃª nÃ£o tem casa.' });

    const casa = casas[u.casa];
    kimorin.sendMessage(from, { text: `ğŸ  Sua casa: ${u.casa}\nDescriÃ§Ã£o: ${casa.descricao}` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function caseroleta(kimorin, from, id, args, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const aposta = parseInt(args[0]);
    if (isNaN(aposta) || aposta <= 0) return kimorin.sendMessage(from, { text: 'âŒ Valor invÃ¡lido.' });
    if (u.moedas < aposta) return kimorin.sendMessage(from, { text: 'ğŸ’¸ VocÃª nÃ£o tem moedas suficientes.' });

    const resultado = Math.floor(Math.random() * 10);
    if (resultado >= 7) {
      const ganho = aposta * 2;
      u.moedas += ganho;
      salvar(db);
      kimorin.sendMessage(from, { text: `ğŸ‰ ParabÃ©ns! VocÃª ganhou ${ganho} moedas na roleta.` });
    } else {
      u.moedas -= aposta;
      salvar(db);
      kimorin.sendMessage(from, { text: `ğŸ˜¢ VocÃª perdeu ${aposta} moedas na roleta.` });
    }
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

const conquistas = {
  explorador: { descricao: "Explorou 10 vezes", requisito: 10 },
  trabalhador: { descricao: "Trabalhou 20 vezes", requisito: 20 },
  rico: { descricao: "Acumulou 10.000 moedas", requisito: 10000 }
};

function caseverconquistas(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    if (!u.conquistas) u.conquistas = {};

    let texto = "*ğŸ† Conquistas:* \n";
    for (const chave in conquistas) {
      const c = conquistas[chave];
      const alcanÃ§ada = u.conquistas[chave] === true ? "âœ…" : "âŒ";
      texto += `${alcanÃ§ada} ${c.descricao}\n`;
    }
    kimorin.sendMessage(from, { text: texto });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// FunÃ§Ã£o auxiliar para checar e atualizar conquistas (chame apÃ³s aÃ§Ãµes)
function checarConquistas(u) {
  if (!u.conquistas) u.conquistas = {};
  if ((u.exploracoes || 0) >= 10) u.conquistas.explorador = true;
  if ((u.trabalhos || 0) >= 20) u.conquistas.trabalhador = true;
  if ((u.moedas || 0) >= 10000) u.conquistas.rico = true;
}

const missoes = [
  { id: "explorar", descricao: "Explore 3 vezes", objetivo: 3 },
  { id: "trabalhar", descricao: "Trabalhe 2 vezes", objetivo: 2 },
  { id: "alimentarpet", descricao: "Alimente seu pet 1 vez", objetivo: 1 }
];

function casemissoes(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    if (!u.missoes) {
      u.missoes = missoes.map(m => ({ id: m.id, progresso: 0, completo: false }));
    }

    let texto = "*ğŸ“œ MissÃµes DiÃ¡rias:*\n";
    u.missoes.forEach(m => {
      const mdef = missoes.find(x => x.id === m.id);
      texto += `- ${mdef.descricao}: ${m.progresso}/${mdef.objetivo} ${m.completo ? "âœ…" : "âŒ"}\n`;
    });

    salvar(db);
    kimorin.sendMessage(from, { text: texto });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// FunÃ§Ã£o auxiliar para atualizar missÃµes (chame apÃ³s eventos)
function atualizarMissao(u, idMissao, qtd=1) {
  if (!u.missoes) return;
  const m = u.missoes.find(x => x.id === idMissao);
  if (!m || m.completo) return;

  m.progresso += qtd;
  const objetivo = missoes.find(x => x.id === idMissao).objetivo;
  if (m.progresso >= objetivo) {
    m.completo = true;
  }
}

const receitas = {
  'poÃ§Ã£o_avanÃ§ada': { ingredientes: { 'cura': 2, 'moedas': 50 }, resultado: 'poÃ§Ã£o_avanÃ§ada' }
  // Exemplo, vocÃª pode expandir
};

function casecraft(kimorin, from, id, args, prefix) {
  try {
    const item = args[0]?.toLowerCase();
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (!item || !receitas[item]) return kimorin.sendMessage(from, { text: "âŒ Receita nÃ£o encontrada." });

    const receita = receitas[item];
    // Verifica ingredientes
    for (const ing in receita.ingredientes) {
      const qtd = receita.ingredientes[ing];
      if (ing === 'moedas') {
        if (u.moedas < qtd) return kimorin.sendMessage(from, { text: "ğŸ’¸ Moedas insuficientes." });
      } else {
        const invQtd = u.inventario.filter(i => i === ing).length;
        if (invQtd < qtd) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem ${qtd}x ${ing}.` });
      }
    }
    // Remove ingredientes
    for (const ing in receita.ingredientes) {
      const qtd = receita.ingredientes[ing];
      if (ing === 'moedas') {
        u.moedas -= qtd;
      } else {
        for (let i=0; i<qtd; i++) {
          const idx = u.inventario.indexOf(ing);
          if (idx > -1) u.inventario.splice(idx, 1);
        }
      }
    }
    // Adiciona resultado
    u.inventario.push(receita.resultado);
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ› ï¸ VocÃª criou ${item} com sucesso!` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function casecacaotesouro(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    const chance = Math.random();
    if (chance > 0.7) {
      const premio = Math.floor(Math.random() * 500) + 200;
      u.moedas += premio;
      salvar(db);
      kimorin.sendMessage(from, { text: `ğŸ‰ VocÃª encontrou um tesouro com ${premio} moedas!` });
    } else {
      kimorin.sendMessage(from, { text: "ğŸ˜¢ VocÃª nÃ£o encontrou nada dessa vez." });
    }
  } catch (e) {
    kimorin.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function casemeuestado(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

    if (u.energia === undefined) u.energia = 100;
    if (u.fome === undefined) u.fome = 100;

    kimorin.sendMessage(from, {
      text: `ğŸ“Š *Seu Estado Atual*\n\nâš¡ Energia: ${u.energia}/100\nğŸ— Fome: ${u.fome}/100`
    });
  } catch (e) {
    kimorin.sendMessage(from, { text: `Erro: ${e.message}` });
  }
}

let leilao = null; // variÃ¡vel simples em memÃ³ria

function casemercado(bot, from) {
  try {
    let texto = "ğŸ›’ *Mercado DisponÃ­vel:*\n";
    for (const key in loja) {
      texto += `- ${loja[key].nome} (PreÃ§o: ${loja[key].preco} moedas)\n`;
    }
    bot.sendMessage(from, { text: texto });
  } catch (e) {
    bot.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// ComeÃ§ar leilÃ£o
function caseleilao(bot, from, id, args) {
  try {
    if (leilao) return bot.sendMessage(from, { text: 'âš ï¸ JÃ¡ hÃ¡ um leilÃ£o em andamento.' });
    const item = args[0];
    if (!item || !loja[item]) return bot.sendMessage(from, { text: 'âŒ Item invÃ¡lido para leilÃ£o.' });

    leilao = {
      item,
      dono: id,
      lanceAtual: 0,
      maiorLance: null,
      fim: Date.now() + 60000 // 1 min leilÃ£o
    };

    bot.sendMessage(from, { text: `ğŸ“¢ LeilÃ£o iniciado para ${loja[item].nome}! Use "lance [valor]" para participar.` });

    // Finaliza leilÃ£o apÃ³s 1 min
    setTimeout(() => {
      if (!leilao) return;
      const db = carregar();
      if (leilao.maiorLance && db[leilao.maiorLance.id] && db[leilao.maiorLance.id].moedas >= leilao.lanceAtual) {
        db[leilao.maiorLance.id].moedas -= leilao.lanceAtual;
        db[leilao.maiorLance.id].inventario.push(leilao.item);
        db[leilao.dono].moedas += leilao.lanceAtual;
        salvar(db);
        bot.sendMessage(from, { text: `ğŸ‰ LeilÃ£o finalizado! ${db[leilao.maiorLance.id].nome} ganhou o ${loja[leilao.item].nome} por ${leilao.lanceAtual} moedas.` });
      } else {
        bot.sendMessage(from, { text: 'ğŸ˜ LeilÃ£o finalizado sem vencedores.' });
      }
      leilao = null;
    }, 60000);
  } catch (e) {
    bot.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

// Dar lance no leilÃ£o
function caselance(bot, from, id, args) {
  try {
    if (!leilao) return bot.sendMessage(from, { text: 'âŒ NÃ£o hÃ¡ leilÃ£o ativo.' });
    const lance = parseInt(args[0]);
    if (isNaN(lance) || lance <= leilao.lanceAtual) return bot.sendMessage(from, { text: 'âŒ Lance invÃ¡lido ou menor que o atual.' });

    const db = carregar();
    const u = db[id];
    if (!u) return bot.sendMessage(from, { text: 'âŒ Registre-se primeiro.' });
    if (u.moedas < lance) return bot.sendMessage(from, { text: 'ğŸ’¸ Moedas insuficientes para o lance.' });

    leilao.lanceAtual = lance;
    leilao.maiorLance = { id, nome: u.nome };
    bot.sendMessage(from, { text: `ğŸ’° Lance de ${lance} moedas registrado por ${u.nome}!` });
  } catch (e) {
    bot.sendMessage(from, { text: `âŒ Erro: ${e.message}` });
  }
}

function casecomer(kimorin, from, id, prefix) {
  try {
    const db = carregar();
    const u = db[id];
    if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });
    if (u.moedas < 50) return kimorin.sendMessage(from, { text: "ğŸ’¸ VocÃª precisa de 50 moedas para comer." });

    u.fome = Math.min(100, (u.fome || 0) + 50);
    u.moedas -= 50;
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ” VocÃª comeu e recuperou energia. Fome agora: ${u.fome}/100` });
  } catch (e) {
    kimorin.sendMessage(from, { text: `Erro: ${e.message}` });
  }
}

function recuperarEnergia(u) {
  if (u.energia === undefined) u.energia = 100;
  u.energia = Math.min(100, u.energia + 10);
}

function casesaldo(kimorin, from, id, prefix) {
  const db = carregar();
  const u = db[id];
  if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

  u.banco = u.banco || 0;
  kimorin.sendMessage(from, {
    text: `ğŸ¦ *Saldo BancÃ¡rio*\nğŸ’° Carteira: ${u.moedas || 0}\nğŸ¦ Banco: ${u.banco}`
  });
}

function casedepositar(kimorin, from, id, args, prefix) {
  const db = carregar();
  const u = db[id];
  const valor = parseInt(args[0]);
  if (!u || isNaN(valor) || valor <= 0 || u.moedas < valor) return kimorin.sendMessage(from, { text: 'âŒ Valor invÃ¡lido ou saldo insuficiente.' });

  u.moedas -= valor;
  u.banco = (u.banco || 0) + valor;
  salvar(db);
  kimorin.sendMessage(from, { text: `âœ… VocÃª depositou ${valor} moedas no banco.` });
}

function casesacar(kimorin, from, id, args) {
  const db = carregar();
  const u = db[id];
  const valor = parseInt(args[0]);
  if (!u || isNaN(valor) || valor <= 0 || (u.banco || 0) < valor) return kimorin.sendMessage(from, { text: 'âŒ Valor invÃ¡lido ou saldo insuficiente no banco.' });

  u.moedas += valor;
  u.banco -= valor;
  salvar(db);
  kimorin.sendMessage(from, { text: `ğŸ§ VocÃª sacou ${valor} moedas.` });
}

function caseroubar(kimorin, from, id, prefix) {
  const db = carregar();
  const u = db[id];
  if (!u) return kimorin.sendMessage(from, { text: `âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]` });

  const chance = Math.random();
  if (chance > 0.7) {
    const ganho = Math.floor(Math.random() * 500) + 100;
    u.moedas += ganho;
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸ•¶ï¸ VocÃª roubou com sucesso e ganhou ${ganho} moedas!` });
  } else {
    const perda = Math.floor(Math.random() * 300) + 100;
    u.moedas = Math.max(0, u.moedas - perda);
    salvar(db);
    kimorin.sendMessage(from, { text: `ğŸš¨ VocÃª foi pego! Perdeu ${perda} moedas.` });
  }
}

function casesortedodia(kimorin, from, id, prefix) {
  const db = carregar();
  const u = db[id];
  const hoje = new Date().toDateString();

  if (u.ultimaSorte === hoje) return kimorin.sendMessage(from, { text: 'ğŸ€ VocÃª jÃ¡ usou sua sorte hoje.' });

  const sorte = [
    "Ganhou 300 moedas!",
    "Nada aconteceu...",
    "Perdeu 100 moedas!",
    "Ganhou XP extra!",
    "Ganhou item raro!"
  ];

  const resultado = sorte[Math.floor(Math.random() * sorte.length)];
  u.ultimaSorte = hoje;

  if (resultado.includes("300")) u.moedas += 300;
  if (resultado.includes("100")) u.moedas = Math.max(0, u.moedas - 100);
  if (resultado.includes("XP")) u.xp += 20;
  if (resultado.includes("item")) u.inventario.push("item_raro");

  salvar(db);
  kimorin.sendMessage(from, { text: `ğŸ”® Sorte do Dia: ${resultado}` });
}

// RENASCER
function caserenascer(kimorin,from,id, prefix){
  try{
    const db=carregar();const u=db[id];
    if(!u) return kimorin.sendMessage(from,{text:`âŒ VocÃª nÃ£o tem uma conta\nâœ…Use ${prefix}registrar [nome]`});
    if(u.status!=='morto') return kimorin.sendMessage(from,{text:'ğŸ˜… Seu pet estÃ¡ vivo!'});

    if(u.moedas<500) return kimorin.sendMessage(from,{text:'ğŸ’¸ 500 moedas para renascer.'});
    u.moedas-=500; u.status='vivo'; u.vida=100; u.fome=100; u.sono=100;
    u.higiene=100; u.diversao=100; salvar(db);
    kimorin.sendMessage(from,{text:'âœ¨ Seu pet renasceu completamente saudÃ¡vel!'});
  }catch(e){kimorin.sendMessage(from,{text:`âŒ Erro: ${e.message}`});}
}

module.exports = {
  caseregistrar,
  casestatus,
  casealimentar,
  casedormir,
  casebanho,
  casebrincar,
  caseloja,
  caseinventario,
  caseusaritem,
  caseequipar,
  casecura,
  caserankingxp,
  caseevento,
  casecomprar,
  caseleilao,
  caselance,
  casedesafios,
  casemissoes,
  caseranking,
  caserenascer,
  caseexplorar,
  casecurar,
  caseverconquistas,
  casecraft,
  casecacaotesouro,
  casecoletar,
  casedoar,
  casecriarpet,
  casestatuspet,
  casealimentarpet,
  casetreinarpet,
  casemeuestado,
  casecomer,
  casesaldo,
  casedepositar,
  casesacar,
  caseroubar,
  casesortedodia,
  casecasar,
  casemercado,
  caseaceitarcasamento,
  casedivorcio,
  caseescolhertrabalho,
  casetrabalhar,
  casevertrabalho,
  casedemitir,
  caseferias,
  casecomprarcasa,
  caseminhacasa,
  caseroleta
};